<%- include('../partials/header') %>
    <link rel="stylesheet" href="/css/admin.css">

    <%- include('../partials/navbar') %>

        <div class="admin-layout">
            <%- include('../partials/admin-sidebar') %>

                <main class="admin-content">
                    <!-- Breadcrumb -->
                    <nav aria-label="breadcrumb" class="mb-4">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/admin/dashboard"><i class="bi bi-house-door"></i>
                                    <%= locals.userRole==='admin' ? 'Administration' : 'Espace Membre' %>
                                </a></li>
                            <li class="breadcrumb-item active" aria-current="page">Alertes</li>
                        </ol>
                    </nav>

                    <!-- Page Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="h3 mb-1 fw-bold text-primary">
                                <i class="bi bi-bell-fill me-2"></i>Alertes du Système
                            </h1>
                            <p class="text-muted mb-0">Gestion et suivi des alertes de zones et dérive</p>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary shadow-sm" onclick="refreshAlerts()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Actualiser
                            </button>
                        </div>
                    </div>

                    <!-- Statistiques -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-danger bg-opacity-10 p-3 rounded-circle text-danger me-3">
                                            <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                                        </div>
                                        <div>
                                            <p class="text-muted mb-0 small">Alertes Actives</p>
                                            <h3 class="mb-0 fw-bold" id="stat-active">0</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning me-3">
                                            <i class="bi bi-exclamation-circle-fill fs-4"></i>
                                        </div>
                                        <div>
                                            <p class="text-muted mb-0 small">Critiques</p>
                                            <h3 class="mb-0 fw-bold" id="stat-critical">0</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success me-3">
                                            <i class="bi bi-check-circle-fill fs-4"></i>
                                        </div>
                                        <div>
                                            <p class="text-muted mb-0 small">Résolues</p>
                                            <h3 class="mb-0 fw-bold" id="stat-resolved">0</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-info bg-opacity-10 p-3 rounded-circle text-info me-3">
                                            <i class="bi bi-graph-up fs-4"></i>
                                        </div>
                                        <div>
                                            <p class="text-muted mb-0 small">Total</p>
                                            <h3 class="mb-0 fw-bold" id="stat-total">0</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label small">Statut</label>
                                    <select class="form-select" id="filter-status" onchange="applyFilters()">
                                        <option value="all">Toutes</option>
                                        <option value="active" selected>Actives uniquement</option>
                                        <option value="resolved">Résolues uniquement</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Sévérité</label>
                                    <select class="form-select" id="filter-severity" onchange="applyFilters()">
                                        <option value="all">Toutes</option>
                                        <option value="critical">Critiques</option>
                                        <option value="warning">Avertissements</option>
                                        <option value="info">Informations</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Type</label>
                                    <select class="form-select" id="filter-type" onchange="applyFilters()">
                                        <option value="all">Tous</option>
                                        <option value="zone_violation">Violation de zone</option>
                                        <option value="drift_warning">Dérive</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">&nbsp;</label>
                                    <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                        <i class="bi bi-x-circle me-1"></i>Réinitialiser
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Liste des alertes -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 py-3">
                            <h5 class="mb-0 fw-bold text-dark">
                                <i class="bi bi-list-ul me-2 text-primary"></i>Liste des Alertes
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="alerts-container">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Chargement...</span>
                                    </div>
                                    <p class="text-muted mt-2">Chargement des alertes...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
        </div>

        <script>
            let allAlerts = [];

            document.addEventListener('DOMContentLoaded', function () {
                loadAlerts();
                loadStats();
            });

            async function loadAlerts() {
                try {
                    const response = await fetch('/api/alerts', { credentials: 'include' });
                    const data = await response.json();

                    if (data.success) {
                        allAlerts = data.alerts;
                        applyFilters();
                    } else {
                        showError('Erreur lors du chargement des alertes');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    showError('Impossible de charger les alertes');
                }
            }

            async function loadStats() {
                try {
                    const response = await fetch('/api/alerts/stats', { credentials: 'include' });
                    const data = await response.json();

                    if (data.success) {
                        const stats = data.stats;
                        document.getElementById('stat-active').textContent = stats.active || 0;
                        document.getElementById('stat-critical').textContent = stats.critical || 0;
                        document.getElementById('stat-resolved').textContent = stats.resolved || 0;
                        document.getElementById('stat-total').textContent = stats.total || 0;
                    }
                } catch (error) {
                    console.error('Erreur stats:', error);
                }
            }

            function applyFilters() {
                const statusFilter = document.getElementById('filter-status').value;
                const severityFilter = document.getElementById('filter-severity').value;
                const typeFilter = document.getElementById('filter-type').value;

                let filtered = allAlerts.filter(alert => {
                    // Filtre statut
                    if (statusFilter === 'active' && alert.acknowledged) return false;
                    if (statusFilter === 'resolved' && !alert.acknowledged) return false;

                    // Filtre sévérité
                    if (severityFilter !== 'all' && alert.severity !== severityFilter) return false;

                    // Filtre type
                    if (typeFilter !== 'all' && alert.type !== typeFilter) return false;

                    return true;
                });

                displayAlerts(filtered);
            }

            function displayAlerts(alerts) {
                const container = document.getElementById('alerts-container');

                if (alerts.length === 0) {
                    container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                    <p class="text-muted mt-3">Aucune alerte à afficher</p>
                </div>
            `;
                    return;
                }

                const html = alerts.map(alert => {
                    const severityClass = {
                        'critical': 'danger',
                        'warning': 'warning',
                        'info': 'info'
                    }[alert.severity] || 'secondary';

                    const typeIcon = {
                        'zone_violation': 'bi-geo-alt-fill',
                        'drift_warning': 'bi-compass-fill',
                        'sos': 'bi-exclamation-octagon-fill'
                    }[alert.type] || 'bi-bell-fill';

                    const date = new Date(alert.created_at).toLocaleString('fr-FR');

                    return `
                <div class="alert-item ${alert.acknowledged ? 'acknowledged' : ''}" data-alert-id="${alert.id}">
                    <div class="d-flex align-items-start p-3 border-bottom">
                        <div class="me-3">
                            <div class="bg-${severityClass} bg-opacity-10 p-2 rounded-circle text-${severityClass}">
                                <i class="bi ${typeIcon} fs-5"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1 fw-bold">${alert.boat_name || 'Bateau inconnu'} ${alert.zone_name ? `- ${alert.zone_name}` : ''}</h6>
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-1"></i>${date}
                                        ${alert.registration_number ? `<span class="ms-2"><i class="bi bi-tag me-1"></i>${alert.registration_number}</span>` : ''}
                                    </small>
                                </div>
                                <div>
                                    <span class="badge bg-${severityClass}">${alert.severity.toUpperCase()}</span>
                                </div>
                            </div>
                            <p class="mb-2">${alert.message}</p>
                            ${alert.latitude && alert.longitude ? `
                                <small class="text-muted">
                                    <i class="bi bi-geo me-1"></i>Position: ${alert.latitude.toFixed(4)}, ${alert.longitude.toFixed(4)}
                                </small>
                            ` : ''}
                            ${alert.acknowledged ? `
                                <div class="mt-2">
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle me-1"></i>Acquittée par ${alert.acknowledged_by_name || 'Utilisateur'}
                                    </span>
                                </div>
                            ` : `
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="acknowledgeAlert(${alert.id})">
                                        <i class="bi bi-check2 me-1"></i>Acquitter
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
                }).join('');

                container.innerHTML = html;
            }

            async function acknowledgeAlert(alertId) {
                if (!confirm('Voulez-vous vraiment acquitter cette alerte ?')) return;

                try {
                    const response = await fetch(`/api/alerts/${alertId}/acknowledge`, {
                        method: 'PUT',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Recharger les alertes
                        await loadAlerts();
                        await loadStats();
                    } else {
                        alert('Erreur lors de l\'acquittement de l\'alerte');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('Erreur lors de l\'acquittement de l\'alerte');
                }
            }

            function resetFilters() {
                document.getElementById('filter-status').value = 'active';
                document.getElementById('filter-severity').value = 'all';
                document.getElementById('filter-type').value = 'all';
                applyFilters();
            }

            function refreshAlerts() {
                loadAlerts();
                loadStats();
            }

            function showError(message) {
                const container = document.getElementById('alerts-container');
                container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-exclamation-triangle text-danger" style="font-size: 4rem;"></i>
                <p class="text-danger mt-3">${message}</p>
            </div>
        `;
            }
        </script>

        <style>
            .alert-item {
                transition: background-color 0.2s;
            }

            .alert-item:hover {
                background-color: rgba(0, 0, 0, 0.02);
            }

            .alert-item.acknowledged {
                opacity: 0.6;
            }
        </style>

        <%- include('../partials/footer') %>