<%- include('../partials/header') %>
  <%- include('../partials/navbar') %>

    <style>
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --glass-bg: rgba(255, 255, 255, 0.9);
        --glass-border: 1px solid rgba(255, 255, 255, 0.5);
        --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        --card-radius: 20px;
      }

      body {
        background: #f0f2f5;
        background-image:
          radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
          radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
          radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
        background-attachment: fixed;
      }

      .dashboard-container {
        padding: 2rem;
      }

      .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: var(--glass-border);
        box-shadow: var(--glass-shadow);
        border-radius: var(--card-radius);
        padding: 1.5rem;
        height: 100%;
        transition: transform 0.2s;
      }

      .glass-card:hover {
        transform: translateY(-2px);
      }

      .metric-value {
        font-size: 2.2rem;
        font-weight: 800;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .metric-label {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #6c757d;
        font-size: 0.75rem;
      }

      /* Map Styling */
      #map {
        height: 100%;
        min-height: 450px;
        border-radius: 12px;
        z-index: 1;
      }

      /* Sidebar Specifics */
      .sidebar-card {
        background: rgba(255, 255, 255, 0.85);
        border-radius: 16px;
        padding: 1.25rem;
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }

      .sos-alert-animation {
        animation: pulse-red 1.5s infinite;
      }

      @keyframes pulse-red {
        0% {
          box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
        }

        70% {
          box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
        }

        100% {
          box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
      }
    </style>

    <div class="container-fluid dashboard-container">
      <div class="row g-4">

        <!-- SIDEBAR (Left Column) -->
        <div class="col-lg-3 col-xl-2 d-flex flex-column gap-4">

          <!-- Weather Widget -->
          <div class="glass-card p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="fw-bold m-0"><i class="bi bi-cloud-sun me-2 text-primary"></i>Météo Marine</h6>
            </div>

            <div class="text-center">
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <div class="sidebar-card">
                    <div class="text-muted small" style="font-size: 0.7rem;">VENT</div>
                    <div class="fw-bold fs-5" id="wind-speed">--</div>
                    <small class="text-muted" style="font-size: 0.7rem;">km/h</small>
                  </div>
                </div>
                <div class="col-6">
                  <div class="sidebar-card">
                    <div class="text-muted small" style="font-size: 0.7rem;">HOULE</div>
                    <div class="fw-bold fs-5" id="wave-height">--</div>
                    <small class="text-muted" style="font-size: 0.7rem;">m</small>
                  </div>
                </div>
              </div>

              <div class="alert p-2 mb-0 fw-bold d-flex flex-column align-items-center justify-content-center"
                id="flag-alert" style="font-size: 0.8rem;">
                <i class="bi bi-flag-fill fs-4 mb-1" id="flag-icon"></i>
                <span id="flag-text">Initialisation...</span>
              </div>
            </div>
          </div>

          <!-- SOS / Safety Widget -->
          <div class="glass-card p-3">
            <h6 class="fw-bold mb-3"><i class="bi bi-life-preserver me-2 text-danger"></i>Sécurité & SOS</h6>

            <div id="sos-container">
              <!-- Default Safe State -->
              <div
                class="d-flex align-items-center p-3 rounded-3 bg-success bg-opacity-10 text-success border border-success"
                id="sos-status-box">
                <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                <div style="line-height:1.2;">
                  <div class="fw-bold">R.A.S</div>
                  <small>Aucune alerte</small>
                </div>
              </div>
            </div>

            <!-- Simulation Trigger (Hidden from prod, shown for demo) -->
            <button class="btn btn-sm btn-outline-danger w-100 mt-3" onclick="triggerSimulatedSOS()">
              <i class="bi bi-exclamation-triangle me-2"></i>Simuler SOS
            </button>
          </div>

          <!-- System Info -->
          <div class="sidebar-card text-center">
            <small class="text-muted d-block mb-2">Dernière maj</small>
            <div class="fw-bold text-primary" id="update-time">--:--:--</div>
          </div>
        </div>

        <!-- MAIN CONTENT (Right Column) -->
        <div class="col-lg-9 col-xl-10">
          <!-- Header -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h3 class="fw-bold mb-0">Tableau de Bord</h3>
              <p class="text-muted mb-0">Surveillance temps réel • Zone Conakry</p>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-light rounded-pill shadow-sm fw-bold text-primary" onclick="refreshAllZones()">
                <i class="bi bi-arrow-clockwise me-2"></i>Actualiser
              </button>
              <span class="badge bg-success rounded-pill d-flex align-items-center px-3">
                <i class="bi bi-wifi me-2"></i> En ligne
              </span>
            </div>
          </div>

          <!-- Metrics Row -->
          <div class="row g-4 mb-4">
            <div class="col-md-4">
              <div class="glass-card d-flex align-items-center justify-content-between p-4">
                <div>
                  <div class="metric-label">pH Moyen</div>
                  <div class="metric-value" id="disp-ph">7.2</div>
                  <small class="text-success fw-bold"><i class="bi bi-arrow-up-short"></i> Stable</small>
                </div>
                <div class="bg-light p-3 rounded-circle text-primary fs-3"><i class="bi bi-droplet"></i></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="glass-card d-flex align-items-center justify-content-between p-4">
                <div>
                  <div class="metric-label">Température</div>
                  <div class="metric-value" id="disp-temp">26.5°C</div>
                  <small class="text-success fw-bold"><i class="bi bi-check"></i> Optimale</small>
                </div>
                <div class="bg-light p-3 rounded-circle text-danger fs-3"><i class="bi bi-thermometer-half"></i></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="glass-card d-flex align-items-center justify-content-between p-4">
                <div>
                  <div class="metric-label">Turbidité</div>
                  <div class="metric-value" id="disp-turb">15 NTU</div>
                  <small class="text-muted fw-bold">Claire</small>
                </div>
                <div class="bg-light p-3 rounded-circle text-info fs-3"><i class="bi bi-water"></i></div>
              </div>
            </div>
          </div>

          <!-- Map & Controls -->
          <div class="row g-4 mb-4">
            <div class="col-xl-8">
              <div class="glass-card p-0 overflow-hidden d-flex flex-column h-100">
                <div id="map"></div>
              </div>
            </div>
            <div class="col-xl-4">
              <div class="glass-card control-panel">
                <h5 class="fw-bold mb-4"><i class="bi bi-sliders me-2 text-primary"></i>Diagnostic IA</h5>

                <div class="alert alert-light border mb-4 shadow-sm" id="ia-alert-box">
                  <div class="d-flex align-items-center mb-2">
                    <div class="spinner-grow spinner-grow-sm text-primary me-2" role="status"></div>
                    <strong class="text-primary">IA en attente...</strong>
                  </div>
                  <small class="text-muted">Cliquez sur Analyser pour lancer le diagnostic.</small>
                </div>

                <form onsubmit="event.preventDefault(); manualAnalyze();">
                  <div class="mb-3">
                    <label class="form-label small fw-bold text-uppercase">pH</label>
                    <input type="number" step="0.1" class="form-control" id="input-ph" value="7.2">
                  </div>
                  <div class="mb-3">
                    <label class="form-label small fw-bold text-uppercase">Température (°C)</label>
                    <input type="number" step="0.1" class="form-control" id="input-temp" value="27.5">
                  </div>
                  <div class="mb-4">
                    <label class="form-label small fw-bold text-uppercase">Turbidité (NTU)</label>
                    <input type="number" class="form-control" id="input-turb" value="22">
                  </div>
                  <div class="d-grid">
                    <button type="submit" class="btn btn-primary rounded-pill py-2 fw-bold"
                      style="background: var(--primary-gradient); border: none;">
                      <i class="bi bi-magic me-2"></i>Lancer Diagnostic
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Charts -->
          <div class="glass-card">
            <h5 class="fw-bold mb-4"><i class="bi bi-graph-up me-2 text-primary"></i>Historique</h5>
            <div style="height: 250px;">
              <canvas id="mainChart"></canvas>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      // --- SOS LOGIC ---
      let sosActive = false;
      function triggerSimulatedSOS() {
        if (sosActive) return; // Prevent double trigger
        sosActive = true;

        const container = document.getElementById('sos-container');
        const originalContent = container.innerHTML;

        // Show Alert
        container.innerHTML = `
                <div class="alert alert-danger mb-0 sos-alert-animation text-center border-danger">
                    <div class="d-flex justify-content-center align-items-center mb-2">
                        <i class="bi bi-exclamation-triangle-fill fs-1"></i>
                    </div>
                    <h5 class="fw-bold mb-1">ALERTE SOS</h5>
                    <p class="small mb-2">Pirogue #104 - Panne Moteur<br>Zone: Bassin Sud</p>
                    <button class="btn btn-sm btn-danger w-100 fw-bold" onclick="resolveSOS(this)">
                        <i class="bi bi-send me-1"></i>ENVOYER SECOURS
                    </button>
                </div>
            `;

        // Auto-resolve simulation logic (stored in button onclick above)
        window.resolveSOS = function (btn) {
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Envoi...';
          setTimeout(() => {
            sosActive = false;
            container.innerHTML = originalContent;
            alert("Secours envoyés avec succès ! La patrouille a été notifiée.");
          }, 2000);
        }
      }

      // --- MAP CONFIGURATION ---
      const map = L.map('map').setView([9.52, -13.68], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      const zones = [
        { name: "Bassin Principal", coords: [9.52, -13.68], color: "blue", radius: 1500 },
        { name: "Zone Côtière", coords: [9.55, -13.72], color: "green", radius: 1200 },
        { name: "Port", coords: [9.50, -13.70], color: "purple", radius: 1000 }
      ];

      zones.forEach(z => {
        L.circle(z.coords, {
          color: z.color,
          fillColor: z.color,
          fillOpacity: 0.2,
          radius: z.radius
        }).addTo(map);
        L.marker(z.coords).addTo(map)
          .bindPopup(`<b>${z.name}</b><br>Statut: Surveillance active`);
      });

      // --- CHART CONFIGURATION ---
      const ctx = document.getElementById('mainChart').getContext('2d');
      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(102, 126, 234, 0.5)');
      gradient.addColorStop(1, 'rgba(102, 126, 234, 0.0)');

      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({ length: 12 }, (_, i) => `${i * 2}h`),
          datasets: [{
            label: 'pH Moyen',
            data: [7.1, 7.2, 7.3, 7.2, 7.4, 7.5, 7.3, 7.2, 7.1, 7.0, 7.2, 7.3],
            borderColor: '#667eea',
            backgroundColor: gradient,
            fill: true,
            tension: 0.4,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { min: 6, max: 8.5 },
            x: { grid: { display: false } }
          }
        }
      });

      // --- WEATHER & DATA SIMULATION ---
      function updateWeather() {
        const wind = Math.floor(10 + Math.random() * 40);
        const waves = (0.5 + Math.random() * 2.0).toFixed(1);

        document.getElementById('wind-speed').innerText = wind;
        document.getElementById('wave-height').innerText = waves;
        document.getElementById('update-time').innerText = new Date().toLocaleTimeString();

        const flagAlert = document.getElementById('flag-alert');
        const flagIcon = document.getElementById('flag-icon');
        const flagText = document.getElementById('flag-text');

        if (wind > 35 || waves > 1.8) {
          flagAlert.className = "alert p-2 mb-0 fw-bold d-flex flex-column align-items-center justify-content-center bg-danger text-white border-0";
          flagIcon.className = "bi bi-flag-fill fs-4 mb-1 text-white";
          flagText.innerText = "DANGER";
        } else {
          flagAlert.className = "alert p-2 mb-0 fw-bold d-flex flex-column align-items-center justify-content-center bg-success text-white border-0";
          flagIcon.className = "bi bi-flag-fill fs-4 mb-1 text-white";
          flagText.innerText = "AUTORISÉ";
        }
      }
      setInterval(updateWeather, 5000);
      updateWeather();

      // Data Refresh
      function refreshAllZones() {
        const ph = (7 + Math.random() * 0.6 - 0.3).toFixed(2);
        const temp = (26 + Math.random() * 2).toFixed(1);
        const turb = Math.floor(10 + Math.random() * 20);

        document.getElementById('disp-ph').innerText = ph;
        document.getElementById('disp-temp').innerText = temp + "°C";
        document.getElementById('disp-turb').innerText = turb + " NTU";

        document.getElementById('input-ph').value = ph;
        document.getElementById('input-temp').value = temp;
        document.getElementById('input-turb').value = turb;

        manualAnalyze();

        chart.data.datasets[0].data.shift();
        chart.data.datasets[0].data.push(ph);
        chart.update('none');
      }

      function manualAnalyze() {
        const ph = parseFloat(document.getElementById('input-ph').value);
        const turb = parseFloat(document.getElementById('input-turb').value);
        let status = "OPTIMAL", message = "Conditions excellentes.", alertClass = "alert-success";

        if (ph < 6.5 || ph > 8.5 || turb > 30) {
          status = "DANGER"; message = "Qualité critique !"; alertClass = "alert-danger";
        } else if (ph < 7 || turb > 20) {
          status = "ATTENTION"; message = "Qualité moyenne."; alertClass = "alert-warning";
        }

        const alertBox = document.getElementById('ia-alert-box');
        alertBox.className = `alert border mb-4 shadow-sm ${alertClass}`;
        alertBox.innerHTML = `
                <div class="d-flex align-items-center mb-1"><i class="bi bi-robot me-2"></i><strong>${status}</strong></div>
                <div class="small">${message}</div>
            `;
      }
      setInterval(refreshAllZones, 10000);
    </script>

    <%- include('../partials/footer') %>