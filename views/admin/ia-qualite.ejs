<%- include('../partials/header') %>
  <%- include('../partials/navbar') %>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-11">
      <h1 class="text-center section-title display-4 mb-5 text-primary">
        <i class="bi bi-droplet-fill"></i> Surveillance Qualité de l'Eau pour la santé des poissons
      </h1>

      <!-- Carte avec plusieurs zones -->
      <div class="card shadow-lg mb-5">
        <div class="card-header bg-primary text-white text-center">
          <h3><i class="bi bi-geo-alt-fill"></i> Zones de Pêche Surveillées</h3>
        </div>
        <div class="card-body p-4">
          <div id="map" style="height: 500px; border-radius: 12px;" class="shadow"></div>
          <div class="text-center mt-3">
            <span class="badge bg-success me-3">● Excellente</span>
            <span class="badge bg-primary me-3">● Bonne</span>
            <span class="badge bg-warning me-3">● Moyenne</span>
            <span class="badge bg-danger">● Mauvaise</span>
          </div>
          <p class="text-center mt-2 text-muted small" id="current-conditions">
            Chargement conditions...
          </p>
        </div>
      </div>

      <!-- État actuel + Analyse manuelle -->
      <div class="card shadow-lg mb-5">
        <div class="card-header text-white text-center" id="header-quality">
          <h3>État Actuel - Bassin Principal</h3>
        </div>

        <!-- MAIN CONTENT (Right Column) -->
        <div class="col-lg-9 col-xl-10">
          <!-- Header -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h3 class="fw-bold mb-0">Tableau de Bord</h3>
              <p class="text-muted mb-0">Surveillance temps réel • Zone Conakry</p>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-light rounded-pill shadow-sm fw-bold text-primary" onclick="refreshAllZones()">
                <i class="bi bi-arrow-clockwise me-2"></i>Actualiser
              </button>
              <span class="badge bg-success rounded-pill d-flex align-items-center px-3">
                <i class="bi bi-wifi me-2"></i> En ligne
              </span>
            </div>
          </div>

          <!-- Metrics Row -->
          <div class="row g-4 mb-4">
            <div class="col-md-4">
              <div class="glass-card d-flex align-items-center justify-content-between p-4">
                <div>
                  <div class="metric-label">pH Moyen</div>
                  <div class="metric-value" id="disp-ph">7.2</div>
                  <small class="text-success fw-bold"><i class="bi bi-arrow-up-short"></i> Stable</small>
                </div>
                <div class="bg-light p-3 rounded-circle text-primary fs-3"><i class="bi bi-droplet"></i></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="glass-card d-flex align-items-center justify-content-between p-4">
                <div>
                  <div class="metric-label">Température</div>
                  <div class="metric-value" id="disp-temp">26.5°C</div>
                  <small class="text-success fw-bold"><i class="bi bi-check"></i> Optimale</small>
                </div>
                <div class="bg-light p-3 rounded-circle text-danger fs-3"><i class="bi bi-thermometer-half"></i></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="glass-card d-flex align-items-center justify-content-between p-4">
                <div>
                  <div class="metric-label">Turbidité</div>
                  <div class="metric-value" id="disp-turb">15 NTU</div>
                  <small class="text-muted fw-bold">Claire</small>
                </div>
                <div class="bg-light p-3 rounded-circle text-info fs-3"><i class="bi bi-water"></i></div>
              </div>
            </div>
          </div>

          <!-- Map & Controls -->
          <div class="row g-4 mb-4">
            <div class="col-xl-8">
              <div class="glass-card p-0 overflow-hidden d-flex flex-column h-100">
                <div id="map"></div>
              </div>
            </div>
            <div class="col-xl-4">
              <div class="glass-card control-panel">
                <h5 class="fw-bold mb-4"><i class="bi bi-sliders me-2 text-primary"></i>Diagnostic IA</h5>

                <div class="alert alert-light border mb-4 shadow-sm" id="ia-alert-box">
                  <div class="d-flex align-items-center mb-2">
                    <div class="spinner-grow spinner-grow-sm text-primary me-2" role="status"></div>
                    <strong class="text-primary">IA en attente...</strong>
                  </div>
                  <small class="text-muted">Cliquez sur Analyser pour lancer le diagnostic.</small>
                </div>

                <form onsubmit="event.preventDefault(); manualAnalyze();">
                  <div class="mb-3">
                    <label class="form-label small fw-bold text-uppercase">pH</label>
                    <input type="number" step="0.1" class="form-control" id="input-ph" value="7.2">
                  </div>
                  <div class="mb-3">
                    <label class="form-label small fw-bold text-uppercase">Température (°C)</label>
                    <input type="number" step="0.1" class="form-control" id="input-temp" value="27.5">
                  </div>
                  <div class="mb-4">
                    <label class="form-label small fw-bold text-uppercase">Turbidité (NTU)</label>
                    <input type="number" class="form-control" id="input-turb" value="22">
                  </div>
                  <div class="d-grid">
                    <button type="submit" class="btn btn-primary rounded-pill py-2 fw-bold"
                      style="background: var(--primary-gradient); border: none;">
                      <i class="bi bi-magic me-2"></i>Lancer Diagnostic
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Charts -->
          <div class="glass-card">
            <h5 class="fw-bold mb-4"><i class="bi bi-graph-up me-2 text-primary"></i>Historique</h5>
            <div style="height: 250px;">
              <canvas id="mainChart"></canvas>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      // --- SOS LOGIC ---
      let sosActive = false;
      function triggerSimulatedSOS() {
        if (sosActive) return; // Prevent double trigger
        sosActive = true;

        const container = document.getElementById('sos-container');
        const originalContent = container.innerHTML;

        // Show Alert
        container.innerHTML = `
                <div class="alert alert-danger mb-0 sos-alert-animation text-center border-danger">
                    <div class="d-flex justify-content-center align-items-center mb-2">
                        <i class="bi bi-exclamation-triangle-fill fs-1"></i>
                    </div>
                    <h5 class="fw-bold mb-1">ALERTE SOS</h5>
                    <p class="small mb-2">Pirogue #104 - Panne Moteur<br>Zone: Bassin Sud</p>
                    <button class="btn btn-sm btn-danger w-100 fw-bold" onclick="resolveSOS(this)">
                        <i class="bi bi-send me-1"></i>ENVOYER SECOURS
                    </button>
                </div>
            `;

        // Auto-resolve simulation logic (stored in button onclick above)
        window.resolveSOS = function (btn) {
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Envoi...';
          setTimeout(() => {
            sosActive = false;
            container.innerHTML = originalContent;
            alert("Secours envoyés avec succès ! La patrouille a été notifiée.");
          }, 2000);
        }
      }

      // --- MAP CONFIGURATION ---
      const map = L.map('map').setView([9.52, -13.68], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      const zones = [
        { name: "Bassin Principal", coords: [9.52, -13.68], color: "blue", radius: 1500 },
        { name: "Zone Côtière", coords: [9.55, -13.72], color: "green", radius: 1200 },
        { name: "Port", coords: [9.50, -13.70], color: "purple", radius: 1000 }
      ];

      zones.forEach(z => {
        L.circle(z.coords, {
          color: z.color,
          fillColor: z.color,
          fillOpacity: 0.2,
          radius: z.radius
        }).addTo(map);
        L.marker(z.coords).addTo(map)
          .bindPopup(`<b>${z.name}</b><br>Statut: Surveillance active`);
      });

      // --- CHART CONFIGURATION ---
      const ctx = document.getElementById('mainChart').getContext('2d');
      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(102, 126, 234, 0.5)');
      gradient.addColorStop(1, 'rgba(102, 126, 234, 0.0)');

      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({ length: 12 }, (_, i) => `${i * 2}h`),
          datasets: [{
            label: 'pH Moyen',
            data: [7.1, 7.2, 7.3, 7.2, 7.4, 7.5, 7.3, 7.2, 7.1, 7.0, 7.2, 7.3],
            borderColor: '#667eea',
            backgroundColor: gradient,
            fill: true,
            tension: 0.4,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { min: 6, max: 8.5 },
            x: { grid: { display: false } }
          }
        }
      });

      // --- WEATHER & DATA SIMULATION ---
      function updateWeather() {
        const wind = Math.floor(10 + Math.random() * 40);
        const waves = (0.5 + Math.random() * 2.0).toFixed(1);

        document.getElementById('wind-speed').innerText = wind;
        document.getElementById('wave-height').innerText = waves;
        document.getElementById('update-time').innerText = new Date().toLocaleTimeString();

        const flagAlert = document.getElementById('flag-alert');
        const flagIcon = document.getElementById('flag-icon');
        const flagText = document.getElementById('flag-text');

        if (wind > 35 || waves > 1.8) {
          flagAlert.className = "alert p-2 mb-0 fw-bold d-flex flex-column align-items-center justify-content-center bg-danger text-white border-0";
          flagIcon.className = "bi bi-flag-fill fs-4 mb-1 text-white";
          flagText.innerText = "DANGER";
        } else {
          flagAlert.className = "alert p-2 mb-0 fw-bold d-flex flex-column align-items-center justify-content-center bg-success text-white border-0";
          flagIcon.className = "bi bi-flag-fill fs-4 mb-1 text-white";
          flagText.innerText = "AUTORISÉ";
        }
      }
      setInterval(updateWeather, 5000);
      updateWeather();

      // Data Refresh
      function refreshAllZones() {
        const ph = (7 + Math.random() * 0.6 - 0.3).toFixed(2);
        const temp = (26 + Math.random() * 2).toFixed(1);
        const turb = Math.floor(10 + Math.random() * 20);

        document.getElementById('disp-ph').innerText = ph;
        document.getElementById('disp-temp').innerText = temp + "°C";
        document.getElementById('disp-turb').innerText = turb + " NTU";

        document.getElementById('input-ph').value = ph;
        document.getElementById('input-temp').value = temp;
        document.getElementById('input-turb').value = turb;

        manualAnalyze();

        chart.data.datasets[0].data.shift();
        chart.data.datasets[0].data.push(ph);
        chart.update('none');
      }

      function manualAnalyze() {
        const ph = parseFloat(document.getElementById('input-ph').value);
        const turb = parseFloat(document.getElementById('input-turb').value);
        let status = "OPTIMAL", message = "Conditions excellentes.", alertClass = "alert-success";

        if (ph < 6.5 || ph > 8.5 || turb > 30) {
          status = "DANGER"; message = "Qualité critique !"; alertClass = "alert-danger";
        } else if (ph < 7 || turb > 20) {
          status = "ATTENTION"; message = "Qualité moyenne."; alertClass = "alert-warning";
        }

        const alertBox = document.getElementById('ia-alert-box');
        alertBox.className = `alert border mb-4 shadow-sm ${alertClass}`;
        alertBox.innerHTML = `
                <div class="d-flex align-items-center mb-1"><i class="bi bi-robot me-2"></i><strong>${status}</strong></div>
                <div class="small">${message}</div>
            `;
      }
      setInterval(refreshAllZones, 10000);
    </script>

    <%- include('../partials/footer') %>