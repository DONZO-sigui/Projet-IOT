<%- include('../partials/header') %>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="/css/admin.css">

  <style>
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .metric-label {
      font-size: 0.875rem;
      color: #6c757d;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .metric-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #212529;
      line-height: 1.2;
    }

    #map {
      height: 350px;
      width: 100%;
      border-radius: 12px;
      z-index: 1;
    }

    @media (max-width: 768px) {
      .metric-value {
        font-size: 1.5rem;
      }

      #map {
        height: 250px;
      }

      .glass-card {
        padding: 1rem;
      }
    }
  </style>

  <%- include('../partials/navbar') %>

    <div class="admin-layout">
      <%- include('../partials/admin-sidebar') %>

        <main class="admin-content">
          <!-- Breadcrumb -->
          <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="/admin/dashboard"><i class="bi bi-house-door"></i>
                  <%= locals.userRole==='admin' ? 'Administration' : 'Espace Membre' %>
                </a></li>
              <li class="breadcrumb-item active" aria-current="page">Qualité de l'Eau</li>
            </ol>
          </nav>

          <!-- Page Header -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h1 class="h3 mb-1 fw-bold text-primary">
                <i class="bi bi-droplet-fill me-2"></i>Surveillance Qualité de l'Eau
              </h1>
              <p class="text-muted mb-0">Surveillance temps réel • Zone Conakry</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
              <span class="badge bg-success bg-opacity-10 text-success pulse">LIVE</span>
              <button class="btn btn-outline-primary shadow-sm" onclick="refreshAllZones()">
                <i class="bi bi-arrow-clockwise me-2"></i>Actualiser
              </button>
            </div>
          </div>

          <!-- Métriques KPI -->
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between">
                    <div>
                      <p class="text-muted mb-0 small text-uppercase fw-bold">pH Moyen</p>
                      <h3 class="mb-0 fw-bold text-dark" id="disp-ph">7.2</h3>
                      <small class="text-success fw-bold"><i class="bi bi-arrow-up-short"></i> Stable</small>
                    </div>
                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary">
                      <i class="bi bi-droplet fs-3"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between">
                    <div>
                      <p class="text-muted mb-0 small text-uppercase fw-bold">Température</p>
                      <h3 class="mb-0 fw-bold text-dark" id="disp-temp">26.5°C</h3>
                      <small class="text-success fw-bold"><i class="bi bi-check"></i> Optimale</small>
                    </div>
                    <div class="bg-danger bg-opacity-10 p-3 rounded-circle text-danger">
                      <i class="bi bi-thermometer-half fs-3"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between">
                    <div>
                      <p class="text-muted mb-0 small text-uppercase fw-bold">Turbidité</p>
                      <h3 class="mb-0 fw-bold text-dark" id="disp-turb">15 NTU</h3>
                      <small class="text-muted fw-bold">Claire</small>
                    </div>
                    <div class="bg-info bg-opacity-10 p-3 rounded-circle text-info">
                      <i class="bi bi-water fs-3"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Carte + Diagnostic IA -->
          <div class="row g-4 mb-4">
            <!-- Carte -->
            <div class="col-12 col-lg-8">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                  <h5 class="mb-0 fw-bold text-dark">
                    <i class="bi bi-geo-alt-fill me-2 text-primary"></i>Zones de Pêche Surveillées
                  </h5>
                </div>
                <div class="card-body p-0">
                  <div id="map"></div>
                  <div class="p-3 d-flex flex-wrap gap-2">
                    <span class="badge bg-success">● Excellente</span>
                    <span class="badge bg-primary">● Bonne</span>
                    <span class="badge bg-warning text-dark">● Moyenne</span>
                    <span class="badge bg-danger">● Mauvaise</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Diagnostic IA -->
            <div class="col-12 col-lg-4">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                  <h5 class="mb-0 fw-bold text-dark">
                    <i class="bi bi-sliders me-2 text-primary"></i>Diagnostic IA
                  </h5>
                </div>
                <div class="card-body">
                  <div class="alert alert-light border mb-3 shadow-sm" id="ia-alert-box">
                    <div class="d-flex align-items-center mb-2">
                      <div class="spinner-grow spinner-grow-sm text-primary me-2" role="status"></div>
                      <strong class="text-primary">IA en attente...</strong>
                    </div>
                    <small class="text-muted">Cliquez sur Analyser pour lancer le diagnostic.</small>
                  </div>

                  <form onsubmit="event.preventDefault(); manualAnalyze();">
                    <div class="mb-3">
                      <label class="form-label small fw-bold text-uppercase">pH</label>
                      <input type="number" step="0.1" class="form-control" id="input-ph" value="7.2">
                    </div>
                    <div class="mb-3">
                      <label class="form-label small fw-bold text-uppercase">Température (°C)</label>
                      <input type="number" step="0.1" class="form-control" id="input-temp" value="27.5">
                    </div>
                    <div class="mb-3">
                      <label class="form-label small fw-bold text-uppercase">Turbidité (NTU)</label>
                      <input type="number" class="form-control" id="input-turb" value="22">
                    </div>
                    <div class="d-grid">
                      <button type="submit" class="btn btn-primary rounded-pill py-2 fw-bold">
                        <i class="bi bi-magic me-2"></i>Lancer Diagnostic
                      </button>
                    </div>
                  </form>

                  <!-- SOS container -->
                  <div id="sos-container" class="d-none mt-3"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Historique pH -->
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
              <h5 class="mb-0 fw-bold text-dark">
                <i class="bi bi-graph-up me-2 text-primary"></i>Historique Qualité (pH)
              </h5>
            </div>
            <div class="card-body">
              <div style="height: 250px;">
                <canvas id="mainChart"></canvas>
              </div>
            </div>
          </div>

        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
      .pulse {
        animation: pulse-animation 2s infinite;
      }

      @keyframes pulse-animation {
        0% {
          box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.4);
        }

        70% {
          box-shadow: 0 0 0 6px rgba(25, 135, 84, 0);
        }

        100% {
          box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
        }
      }
    </style>

    <script>
      // --- SOS LOGIC ---
      let sosActive = false;
      function triggerSimulatedSOS() {
        if (sosActive) return;
        sosActive = true;
        const container = document.getElementById('sos-container');
        if (!container) return;
        container.classList.remove('d-none');
        const originalContent = container.innerHTML;
        container.innerHTML = `
                <div class="alert alert-danger mb-0 text-center border-danger">
                    <i class="bi bi-exclamation-triangle-fill fs-1 d-block mb-2"></i>
                    <h5 class="fw-bold mb-1">ALERTE SOS</h5>
                    <p class="small mb-2">Pirogue #104 - Panne Moteur<br>Zone: Bassin Sud</p>
                    <button class="btn btn-sm btn-danger w-100 fw-bold" onclick="resolveSOS(this)">
                        <i class="bi bi-send me-1"></i>ENVOYER SECOURS
                    </button>
                </div>`;
        window.resolveSOS = function (btn) {
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Envoi...';
          setTimeout(() => {
            sosActive = false;
            container.innerHTML = originalContent;
            container.classList.add('d-none');
            alert("Secours envoyés avec succès ! La patrouille a été notifiée.");
          }, 2000);
        };
      }

      // --- MAP ---
      let map;
      document.addEventListener('DOMContentLoaded', function () {
        try {
          map = L.map('map').setView([9.52, -13.68], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
          }).addTo(map);

          const zones = [
            { name: "Bassin Principal", coords: [9.52, -13.68], color: "blue", radius: 1500 },
            { name: "Zone Côtière", coords: [9.55, -13.72], color: "green", radius: 1200 },
            { name: "Port", coords: [9.50, -13.70], color: "purple", radius: 1000 }
          ];
          zones.forEach(z => {
            L.circle(z.coords, { color: z.color, fillColor: z.color, fillOpacity: 0.2, radius: z.radius }).addTo(map);
            L.marker(z.coords).addTo(map).bindPopup(`<b>${z.name}</b><br>Statut: Surveillance active`);
          });
          setTimeout(() => map.invalidateSize(), 200);
        } catch (error) {
          console.error('Erreur carte:', error);
        }
      });

      // --- CHART ---
      let chart;
      document.addEventListener('DOMContentLoaded', function () {
        try {
          const ctx = document.getElementById('mainChart').getContext('2d');
          const gradient = ctx.createLinearGradient(0, 0, 0, 300);
          gradient.addColorStop(0, 'rgba(13, 110, 253, 0.5)');
          gradient.addColorStop(1, 'rgba(13, 110, 253, 0.0)');
          chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: Array.from({ length: 12 }, (_, i) => `${i * 2}h`),
              datasets: [{
                label: 'pH Moyen',
                data: [7.1, 7.2, 7.3, 7.2, 7.4, 7.5, 7.3, 7.2, 7.1, 7.0, 7.2, 7.3],
                borderColor: '#0d6efd',
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: { y: { min: 6, max: 8.5 }, x: { grid: { display: false } } }
            }
          });
        } catch (error) {
          console.error('Erreur graphique:', error);
        }
      });

      // --- DATA REFRESH ---
      function refreshAllZones() {
        const ph = (7 + Math.random() * 0.6 - 0.3).toFixed(2);
        const temp = (26 + Math.random() * 2).toFixed(1);
        const turb = Math.floor(10 + Math.random() * 20);

        document.getElementById('disp-ph').innerText = ph;
        document.getElementById('disp-temp').innerText = temp + '°C';
        document.getElementById('disp-turb').innerText = turb + ' NTU';
        document.getElementById('input-ph').value = ph;
        document.getElementById('input-temp').value = temp;
        document.getElementById('input-turb').value = turb;

        manualAnalyze();

        if (chart) {
          chart.data.datasets[0].data.shift();
          chart.data.datasets[0].data.push(parseFloat(ph));
          chart.update('none');
        }
      }

      function manualAnalyze() {
        const ph = parseFloat(document.getElementById('input-ph').value);
        const turb = parseFloat(document.getElementById('input-turb').value);
        let status = 'OPTIMAL', message = 'Conditions excellentes pour la pêche.', alertClass = 'alert-success';

        if (ph < 6.5 || ph > 8.5 || turb > 30) {
          status = 'DANGER';
          message = 'Qualité critique ! Pêche déconseillée.';
          alertClass = 'alert-danger';
        } else if (ph < 7 || turb > 20) {
          status = 'ATTENTION';
          message = 'Qualité moyenne. Surveillance recommandée.';
          alertClass = 'alert-warning';
        }

        const alertBox = document.getElementById('ia-alert-box');
        alertBox.className = `alert border mb-3 shadow-sm ${alertClass}`;
        alertBox.innerHTML = `
                <div class="d-flex align-items-center mb-1">
                    <i class="bi bi-robot me-2"></i>
                    <strong>${status}</strong>
                </div>
                <div class="small">${message}</div>`;
      }

      setInterval(refreshAllZones, 10000);
    </script>

    <%- include('../partials/footer') %>