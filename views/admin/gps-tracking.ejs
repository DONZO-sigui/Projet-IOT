<%- include('../partials/header') %>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="/css/admin.css">

    <%- include('../partials/navbar') %>

        <div class="admin-layout">
            <%- include('../partials/admin-sidebar') %>

                <main class="admin-content">
                    <!-- Breadcrumb -->
                    <nav aria-label="breadcrumb" class="mb-4">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/admin/dashboard"><i class="bi bi-house-door"></i>
                                    <%= locals.userRole==='pecheur' ? 'Mon Espace' : 'Administration' %>
                                </a></li>
                            <li class="breadcrumb-item active" aria-current="page">Suivi GPS</li>
                        </ol>
                    </nav>

                    <!-- Page Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="h3 mb-1">Suivi GPS des Bateaux</h1>
                            <p class="text-muted mb-0">Localisation en temps réel</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="refreshBoats()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Actualiser
                            </button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBoatModal">
                                <i class="bi bi-plus-circle me-2"></i>
                                <%= locals.userRole==='pecheur' ? 'Enregistrer mon Bateau' : 'Ajouter Bateau' %>
                            </button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="row g-4">
                        <!-- Carte -->
                        <div class="col-12 col-lg-8">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white border-0 py-3">
                                    <h5 class="mb-0"><i class="bi bi-map me-2 text-primary"></i>Carte de Suivi</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div id="gps-map" style="height: 600px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Liste des Bateaux -->
                        <div class="col-12 col-lg-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white border-0 py-3">
                                    <h5 class="mb-0"><i class="bi bi-list-ul me-2 text-primary"></i>Bateaux Actifs</h5>
                                </div>
                                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                    <div id="boats-list">
                                        <div class="text-center text-muted py-5">
                                            <i class="bi bi-geo-alt fs-1 mb-3 d-block"></i>
                                            <p>Chargement des bateaux...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Détails Bateau (Modal) -->
                    <div class="modal fade" id="boatDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>Détails du Bateau</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body" id="boat-details-content">
                                    <!-- Contenu chargé dynamiquement -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ajouter Bateau (Modal) -->
                    <div class="modal fade" id="addBoatModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>
                                        <%= locals.userRole==='pecheur' ? 'Enregistrer mon Bateau' : 'Ajouter un Bateau'
                                            %>
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <form id="addBoatForm">
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label class="form-label">Nom du Bateau</label>
                                            <input type="text" class="form-control" name="name" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Numéro d'Immatriculation</label>
                                            <input type="text" class="form-control" name="registrationNumber" required>
                                        </div>
                                        <% if (locals.userRole !=='pecheur' ) { %>
                                            <div class="mb-3">
                                                <label class="form-label">Propriétaire (Pêcheur) <span
                                                        class="text-danger">*</span></label>
                                                <select class="form-select" name="ownerId" required>
                                                    <option value="">-- Sélectionner un pêcheur --</option>
                                                    <% if (pecheurs && pecheurs.length> 0) { %>
                                                        <% pecheurs.forEach(function(pecheur) { %>
                                                            <option value="<%= pecheur.id %>">
                                                                <%= pecheur.username %>
                                                                    <% if (pecheur.email) { %>
                                                                        (<%= pecheur.email %>)
                                                                            <% } %>
                                                            </option>
                                                            <% }); %>
                                                                <% } else { %>
                                                                    <option value="" disabled>Aucun pêcheur disponible
                                                                    </option>
                                                                    <% } %>
                                                </select>
                                                <small class="form-text text-muted">
                                                    <i class="bi bi-info-circle me-1"></i>
                                                    Le bateau sera assigné au pêcheur sélectionné
                                                </small>
                                            </div>
                                            <% } %>
                                                <div class="mb-3">
                                                    <label class="form-label">ID Dispositif (ESP32)</label>
                                                    <input type="text" class="form-control" name="deviceId">
                                                    <small class="form-text text-muted">Optionnel - ID du dispositif IoT
                                                        embarqué</small>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Latitude Initiale</label>
                                                        <input type="number" step="any" class="form-control"
                                                            name="latitude" placeholder="ex: 9.52" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Longitude Initiale</label>
                                                        <input type="number" step="any" class="form-control"
                                                            name="longitude" placeholder="ex: -13.68" required>
                                                    </div>
                                                </div>
                                                <small class="form-text text-muted d-block mb-3">
                                                    <i class="bi bi-info-circle me-1"></i>
                                                    Ces coordonnées seront utilisées comme position de départ du bateau.
                                                </small>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="submit" class="btn btn-primary">
                                            <%= locals.userRole==='pecheur' ? 'Soumettre la demande' : 'Ajouter' %>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Modifier Position (Modal) -->
                    <div class="modal fade" id="editPositionModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title"><i class="bi bi-geo-alt-fill me-2"></i>Modifier la Position
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <form id="editPositionForm">
                                    <input type="hidden" name="boatId">
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Nouvelle Latitude</label>
                                                <input type="number" step="any" class="form-control" name="latitude"
                                                    required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Nouvelle Longitude</label>
                                                <input type="number" step="any" class="form-control" name="longitude"
                                                    required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Vitesse (km/h)</label>
                                                <input type="number" step="0.1" class="form-control" name="speed"
                                                    placeholder="0.0">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Cap (degrés)</label>
                                                <input type="number" step="1" class="form-control" name="heading"
                                                    placeholder="0" min="0" max="360">
                                            </div>
                                        </div>
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            Cette mise à jour créera un nouveau point dans l'historique GPS.
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">Annuler</button>
                                        <button type="submit" class="btn btn-warning">Mettre à jour</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                </main>
        </div>

        <!-- Scripts -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

        <script>
            let map;
            let markers = {};
            let boats = [];

            // Initialiser la carte
            document.addEventListener('DOMContentLoaded', function () {
                map = L.map('gps-map').setView([9.52, -13.68], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);

                // Charger les bateaux
                loadBoats();

                // Actualiser toutes les 30 secondes
                setInterval(loadBoats, 30000);
            });

            async function loadBoats() {
                try {
                    const response = await fetch('/api/boats');
                    const data = await response.json();

                    if (data.success) {
                        boats = data.boats;
                        updateBoatsList();
                        updateMapMarkers();
                    }
                } catch (error) {
                    console.error('Erreur chargement bateaux:', error);
                }
            }

            function updateBoatsList() {
                const listContainer = document.getElementById('boats-list');

                if (boats.length === 0) {
                    listContainer.innerHTML = `
        <div class="text-center text-muted py-5">
          <i class="bi bi-geo-alt fs-1 mb-3 d-block"></i>
          <p>Aucun bateau enregistré</p>
        </div>
      `;
                    return;
                }

                listContainer.innerHTML = boats.map(boat => {
                    const statusClass = boat.status === 'active' ? 'success' :
                        (boat.status === 'pending' ? 'warning' : 'secondary');
                    const statusLabel = boat.status === 'active' ? 'ACTIF' :
                        (boat.status === 'pending' ? 'EN ATTENTE' : boat.status.toUpperCase());
                    const hasPosition = boat.lastPosition;
                    const isAdmin = '<%= locals.userRole === "admin" %>' === 'true';

                    return `
        <div class="card mb-3 border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-1">${boat.name}</h6>
                <small class="text-muted d-block">${boat.registration_number || 'N/A'}</small>
                ${isAdmin ? `<small class="text-primary">Proprio: ${boat.owner_name || 'N/A'}</small>` : ''}
              </div>
              <div class="d-flex flex-column align-items-end">
                <span class="badge bg-${statusClass} text-${statusClass === 'warning' ? 'dark' : 'white'}">${statusLabel}</span>
                ${boat.lastPosition && (new Date() - new Date(boat.lastPosition.created_at) < 5 * 60 * 1000) ?
                            `<span class="badge bg-danger mt-1 animate-pulse" title="Signal IoT actif"><i class="bi bi-rss me-1"></i> LIVE</span>` : ''}
              </div>
            </div>
            ${hasPosition ? `
              <div class="mt-2 small">
                <div><i class="bi bi-geo-alt text-primary me-1"></i>${boat.lastPosition.latitude.toFixed(4)}, ${boat.lastPosition.longitude.toFixed(4)}</div>
                <div><i class="bi bi-speedometer text-info me-1"></i>${boat.lastPosition.speed || 0} km/h</div>
              </div>
            ` : '<div class="mt-2 small text-muted">Aucune position GPS</div>'}
            <div class="mt-2 d-flex flex-wrap gap-1">
              <button class="btn btn-sm btn-outline-primary" onclick="centerOnBoat(${boat.id})">
                <i class="bi bi-crosshair"></i> Centrer
              </button>
              <button class="btn btn-sm btn-outline-info" onclick="showBoatDetails(${boat.id})">
                <i class="bi bi-info-circle"></i> Détails
              </button>
              ${isAdmin ? `
                <button class="btn btn-sm btn-outline-warning" onclick="openEditPositionModal(${boat.id})">
                  <i class="bi bi-geo-alt"></i> Position
                </button>
              ` : ''}
              ${isAdmin && boat.status === 'pending' ? `
                <button class="btn btn-sm btn-success" onclick="approveBoat(${boat.id})">
                  <i class="bi bi-check-lg"></i> Valider
                </button>
                <button class="btn btn-sm btn-danger" onclick="rejectBoat(${boat.id})">
                  <i class="bi bi-x-lg"></i> Rejeter
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
                }).join('');
            }

            function updateMapMarkers() {
                // Supprimer les anciens marqueurs
                Object.values(markers).forEach(marker => map.removeLayer(marker));
                markers = {};

                // Ajouter les nouveaux marqueurs
                boats.forEach(boat => {
                    if (boat.lastPosition) {
                        const marker = L.marker([boat.lastPosition.latitude, boat.lastPosition.longitude])
                            .addTo(map)
                            .bindPopup(`
            <strong>${boat.name}</strong><br>
            Vitesse: ${boat.lastPosition.speed || 0} km/h<br>
            <small>${new Date(boat.lastPosition.timestamp).toLocaleString()}</small>
          `);

                        markers[boat.id] = marker;
                    }
                });
            }

            function centerOnBoat(boatId) {
                const boat = boats.find(b => b.id === boatId);
                if (boat && boat.lastPosition) {
                    map.setView([boat.lastPosition.latitude, boat.lastPosition.longitude], 14);
                    markers[boatId].openPopup();
                }
            }

            function showBoatDetails(boatId) {
                const boat = boats.find(b => b.id === boatId);
                if (!boat) return;

                const content = `
      <div class="row">
        <div class="col-md-6">
          <p><strong>Nom:</strong> ${boat.name}</p>
          <p><strong>Immatriculation:</strong> ${boat.registration_number || 'N/A'}</p>
          <p><strong>Propriétaire:</strong> ${boat.owner_name || 'Non assigné'}</p>
        </div>
        <div class="col-md-6">
          <p><strong>Statut:</strong> <span class="badge bg-${boat.status === 'active' ? 'success' : 'secondary'}">${boat.status}</span></p>
          <p><strong>Dispositif:</strong> ${boat.device_id || 'N/A'}</p>
        </div>
      </div>
      ${boat.lastPosition ? `
        <hr>
        <h6>Dernière Position</h6>
        <p><strong>Coordonnées:</strong> ${boat.lastPosition.latitude.toFixed(6)}, ${boat.lastPosition.longitude.toFixed(6)}</p>
        <p><strong>Vitesse:</strong> ${boat.lastPosition.speed || 0} km/h</p>
        <p><strong>Cap:</strong> ${boat.lastPosition.heading || 0}°</p>
        <p><strong>Horodatage:</strong> ${new Date(boat.lastPosition.timestamp).toLocaleString()}</p>
      ` : '<p class="text-muted">Aucune position GPS disponible</p>'}
    `;

                document.getElementById('boat-details-content').innerHTML = content;
                new bootstrap.Modal(document.getElementById('boatDetailsModal')).show();
            }

            async function approveBoat(id) {
                if (!confirm("Voulez-vous vraiment approuver ce bateau ?")) return;
                try {
                    const response = await fetch(`/api/boats/${id}/approve`, { method: 'PUT' });
                    const data = await response.json();
                    if (data.success) {
                        alert(data.message);
                        loadBoats();
                    } else {
                        alert('Erreur: ' + data.error);
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }

            async function rejectBoat(id) {
                if (!confirm("Voulez-vous vraiment rejeter cette demande ? Le bateau sera supprimé.")) return;
                try {
                    const response = await fetch(`/api/boats/${id}/reject`, { method: 'PUT' });
                    const data = await response.json();
                    if (data.success) {
                        alert(data.message);
                        loadBoats();
                    } else {
                        alert('Erreur: ' + data.error);
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }

            function refreshBoats() {
                loadBoats();
            }

            function openEditPositionModal(id) {
                const boat = boats.find(b => b.id === id);
                if (!boat) return;

                const form = document.getElementById('editPositionForm');
                form.boatId.value = id;
                form.latitude.value = boat.lastPosition ? boat.lastPosition.latitude : '';
                form.longitude.value = boat.lastPosition ? boat.lastPosition.longitude : '';
                form.speed.value = boat.lastPosition ? boat.lastPosition.speed : '0';
                form.heading.value = boat.lastPosition ? boat.lastPosition.heading : '0';

                new bootstrap.Modal(document.getElementById('editPositionModal')).show();
            }

            document.getElementById('editPositionForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = this.boatId.value;
                const data = {
                    latitude: this.latitude.value,
                    longitude: this.longitude.value,
                    speed: this.speed.value,
                    heading: this.heading.value
                };

                try {
                    const response = await fetch(`/api/boats/${id}/position/manual`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    if (result.success) {
                        bootstrap.Modal.getInstance(document.getElementById('editPositionModal')).hide();
                        loadBoats();
                        alert(result.message);
                    } else {
                        alert('Erreur: ' + result.error);
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                }
            });

            // Formulaire d'ajout de bateau
            document.getElementById('addBoatForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);

                try {
                    const response = await fetch('/api/boats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        bootstrap.Modal.getInstance(document.getElementById('addBoatModal')).hide();
                        e.target.reset();
                        loadBoats();
                        alert('Bateau ajouté avec succès !');
                    } else {
                        alert('Erreur: ' + result.error);
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('Erreur lors de l\'ajout du bateau');
                }
            });
        </script>

        <%- include('../partials/footer') %>